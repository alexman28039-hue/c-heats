--== HAN'S GUI - FINAL 100% WORKING VERSION ==--
if getgenv().HansGUI_Loaded then return end
getgenv().HansGUI_Loaded = true

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local StarterGui = game:GetService("StarterGui")
local Camera = workspace.CurrentCamera

-- Settings
getgenv().HansGUIThemeColor = getgenv().HansGUIThemeColor or Color3.fromRGB(30, 30, 40)
getgenv().HansGUIcurrentTab = getgenv().HansGUIcurrentTab or "Main Scripts"
getgenv().HansGUIVisible = getgenv().HansGUIVisible ~= false
getgenv().AimbotEnabled = getgenv().AimbotEnabled or false
getgenv().ESPEnabled = getgenv().ESPEnabled or false
getgenv().FOVRadius = getgenv().FOVRadius or 60
getgenv().FOVColor = getgenv().FOVColor or Color3.fromRGB(255, 0, 0)
getgenv().WalkSpeedEnabled = getgenv().WalkSpeedEnabled or false

-- WalkSpeed
local function setWalkSpeed(speed)
    local char = LocalPlayer.Character
    if char and char:FindFirstChild("Humanoid") then
        char.Humanoid.WalkSpeed = speed
    end
end
local function handleWalkSpeed()
    setWalkSpeed(getgenv().WalkSpeedEnabled and 50 or 16)
end
LocalPlayer.CharacterAdded:Connect(function() task.wait(0.1); handleWalkSpeed() end)

local function notify(text, duration)
    pcall(function()
        StarterGui:SetCore("SendNotification", {Title = "Han's GUI", Text = text, Duration = duration or 4})
    end)
end

-- Realistic Tank Simulator 2.0 Kill All (one-click)
local function killAll()
    local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local root = char:FindFirstChild("HumanoidRootPart")
    if not root then return end
    for _, v in Players:GetPlayers() do
        if v ~= LocalPlayer and v.Team ~= LocalPlayer.Team and v.Character then
            local hum = v.Character:FindFirstChild("Humanoid")
            local head = v.Character:FindFirstChild("Head")
            if hum and head and hum.Health > 0 then
                task.spawn(function()
                    for i = 1, 25 do
                        pcall(function()
                            game:GetService("ReplicatedStorage").RemoteEvents.DamageEvent:FireServer(hum, math.huge, head)
                        end)
                        task.wait()
                    end
                end)
            end
        end
    end
    notify("Realistic Tank Simulator 2.0 – Everyone Eliminated")
end

local ScreenGui
local AimbotToggleBtn, ESPToggleBtn, WalkSpeedToggleBtn

local function toggleGUI()
    getgenv().HansGUIVisible = not getgenv().HansGUIVisible
    if ScreenGui then ScreenGui.Enabled = getgenv().HansGUIVisible end
    notify("GUI " .. (getgenv().HansGUIVisible and "Opened" or "Closed"))
end

local function updateToggleButtons()
    if AimbotToggleBtn then AimbotToggleBtn.Text = "Aimbot: " .. (getgenv().AimbotEnabled and "ON" or "OFF")
        AimbotToggleBtn.BackgroundColor3 = getgenv().AimbotEnabled and Color3.fromRGB(0,170,0) or getgenv().HansGUIThemeColor:Lerp(Color3.fromRGB(40,40,40),0.4) end
    if ESPToggleBtn then ESPToggleBtn.Text = "ESP: " .. (getgenv().ESPEnabled and "ON" or "OFF")
        ESPToggleBtn.BackgroundColor3 = getgenv().ESPEnabled and Color3.fromRGB(0,170,0) or getgenv().HansGUIThemeColor:Lerp(Color3.fromRGB(40,40,40),0.4) end
    if WalkSpeedToggleBtn then WalkSpeedToggleBtn.Text = "Speed: " .. (getgenv().WalkSpeedEnabled and "ON" or "OFF")
        WalkSpeedToggleBtn.BackgroundColor3 = getgenv().WalkSpeedEnabled and Color3.fromRGB(0,170,0) or getgenv().HansGUIThemeColor:Lerp(Color3.fromRGB(40,40,40),0.4) end
end

local function createGUI()
    if ScreenGui and ScreenGui.Parent then ScreenGui:Destroy() end
    ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "HansGUI"
    ScreenGui.Enabled = getgenv().HansGUIVisible
    ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

    local Frame = Instance.new("Frame")
    Frame.Size = UDim2.new(0, 800, 0, 560)
    Frame.Position = UDim2.new(0.5, -400, 0.5, -280)
    Frame.BackgroundColor3 = getgenv().HansGUIThemeColor
    Frame.BorderSizePixel = 0
    Frame.Parent = ScreenGui
    Instance.new("UICorner", Frame).CornerRadius = UDim.new(0,16)

    -- Title & Close
    local Title = Instance.new("TextLabel")
    Title.Size = UDim2.new(0,760,0,50); Title.Position = UDim2.new(0,20,0,8)
    Title.BackgroundTransparency = 1; Title.Text = "Han's GUI"
    Title.TextColor3 = Color3.new(1,1,1); Title.Font = Enum.Font.GothamBold; Title.TextSize = 36
    Title.Parent = Frame

    local CloseBtn = Instance.new("TextButton")
    CloseBtn.Size = UDim2.new(0,40,0,40); CloseBtn.Position = UDim2.new(1,-55,0,8)
    CloseBtn.BackgroundColor3 = Color3.fromRGB(220,50,50); CloseBtn.Text = "X"
    CloseBtn.TextColor3 = Color3.new(1,1,1); CloseBtn.Font = Enum.Font.GothamBold; CloseBtn.TextSize = 26
    CloseBtn.Parent = Frame; Instance.new("UICorner",CloseBtn).CornerRadius = UDim.new(0,10)
    CloseBtn.MouseButton1Click:Connect(toggleGUI)

    -- Dragging
    local dragging = false
    local dragInput, dragStart, startPos
    Frame.InputBegan:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then dragging = true; dragStart = i.Position; startPos = Frame.Position end end)
    Frame.InputChanged:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseMovement then dragInput = i end end)
    UserInputService.InputChanged:Connect(function(i) if dragging and i == dragInput then local delta = i.Position - dragStart Frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y) end end)
    Frame.InputEnded:Connect(function() dragging = false end)

    local function addHover(b,n,h)
        b.MouseEnter:Connect(function() TweenService:Create(b,TweenInfo.new(0.2),{Size=h}):Play() end)
        b.MouseLeave:Connect(function() TweenService:Create(b,TweenInfo.new(0.2),{Size=n}):Play() end)
    end

    local allButtons = {}

    -- Centered Tabs
    local tabContainer = Instance.new("Frame", Frame)
    tabContainer.Size = UDim2.new(0,760,0,50); tabContainer.Position = UDim2.new(0,20,0,70)
    tabContainer.BackgroundTransparency = 1

    local function createTab(name, offset)
        local b = Instance.new("TextButton", tabContainer)
        b.Size = UDim2.new(0,180,0,45); b.Position = UDim2.new(0,offset,0,0)
        b.Text = name; b.BackgroundColor3 = getgenv().HansGUIThemeColor:Lerp(Color3.fromRGB(40,40,40),0.4)
        b.TextColor3 = Color3.new(1,1,1); b.Font = Enum.Font.GothamBold; b.TextSize = 20
        Instance.new("UICorner",b).CornerRadius = UDim.new(0,12)
        addHover(b,b.Size,UDim2.new(0,190,0,52))
        table.insert(allButtons,b)
        return b
    end
    local MainTabBtn = createTab("Main Scripts", 100)
    local AimbotTabBtn = createTab("Aimbot", 300)
    local ThemeTabBtn = createTab("Theme", 500)

    -- Pages
    local Pages = {}
    local MainPage = Instance.new("Frame"); MainPage.Size = UDim2.new(0,760,0,400); MainPage.Position = UDim2.new(0,20,0,130)
    MainPage.BackgroundTransparency = 1; MainPage.Parent = Frame; Pages["Main Scripts"] = MainPage

    local AimbotPage = Instance.new("Frame"); AimbotPage.Size = UDim2.new(0,760,0,400); AimbotPage.Position = UDim2.new(0,20,0,130)
    AimbotPage.BackgroundTransparency = 1; AimbotPage.Visible = false; AimbotPage.Parent = Frame; Pages["Aimbot"] = AimbotPage

    local ThemePage = Instance.new("Frame"); ThemePage.Size = UDim2.new(0,760,0,400); ThemePage.Position = UDim2.new(0,20,0,130)
    ThemePage.BackgroundTransparency = 1; ThemePage.Visible = false; ThemePage.Parent = Frame; Pages["Theme"] = ThemePage

    local function updateTheme(c)
        getgenv().HansGUIThemeColor = c; Frame.BackgroundColor3 = c
        local dark = c:Lerp(Color3.fromRGB(30,30,30),0.5); local active = c:Lerp(Color3.new(1,1,1),0.6)
        for _,b in allButtons do
            local isActive = (b==MainTabBtn and getgenv().HansGUIcurrentTab=="Main Scripts") or (b==AimbotTabBtn and getgenv().HansGUIcurrentTab=="Aimbot") or (b==ThemeTabBtn and getgenv().HansGUIcurrentTab=="Theme")
            b.BackgroundColor3 = isActive and active or dark
        end
    end

    local function switchTab(n)
        for name,p in pairs(Pages) do p.Visible = (name==n) end
        getgenv().HansGUIcurrentTab = n
        updateTheme(getgenv().HansGUIThemeColor)
    end
    MainTabBtn.MouseButton1Click:Connect(function() switchTab("Main Scripts") end)
    AimbotTabBtn.MouseButton1Click:Connect(function() switchTab("Aimbot") end)
    ThemeTabBtn.MouseButton1Click:Connect(function() switchTab("Theme") end)

    -- Main Page - 2x3 Grid
    local function createMainBtn(text, callback, col, row)
        local btn = Instance.new("TextButton", MainPage)
        btn.Size = UDim2.new(0, 230, 0, 70)
        btn.Position = UDim2.new(0, 25 + (col-1)*245, 0, 20 + (row-1)*90)
        btn.BackgroundColor3 = getgenv().HansGUIThemeColor:Lerp(Color3.fromRGB(40,40,40),0.4)
        btn.Text = text; btn.TextColor3 = Color3.new(1,1,1); btn.Font = Enum.Font.GothamBold; btn.TextSize = 18
        btn.TextWrapped = true
        Instance.new("UICorner", btn).CornerRadius = UDim.new(0,14)
        addHover(btn, btn.Size, UDim2.new(0,240,0,78))
        table.insert(allButtons, btn)
        btn.MouseButton1Click:Connect(callback)
        return btn
    end

    createMainBtn("Infinite Yield", function() loadstring(game:HttpGet('https://raw.githubusercontent.com/EdgeIY/infiniteyield/master/source',true))() notify("Infinite Yield Loaded!") end, 1, 1)
    createMainBtn("Universal Vehicle Script", function() loadstring(game:HttpGet('https://raw.githubusercontent.com/Documantation12/Universal-Vehicle-Script/main/Main.lua'))() notify("Vehicle Script Loaded!") end, 2, 1)
    WalkSpeedToggleBtn = createMainBtn("", function() getgenv().WalkSpeedEnabled = not getgenv().WalkSpeedEnabled handleWalkSpeed() notify("Speed " .. (getgenv().WalkSpeedEnabled and "ON" or "OFF")) updateToggleButtons() end, 3, 1)

    createMainBtn("Realistic Tank\nSimulator 2.0\nKill All", killAll, 1, 2)
    createMainBtn("Hitbox Script", function() loadstring(game:HttpGet("https://pastebin.com/raw/DA8qiTD6"))() notify("Hitbox Loaded!") end, 2, 2)
    createMainBtn("Execute All Scripts", function() loadstring(game:HttpGet('https://raw.githubusercontent.com/EdgeIY/infiniteyield/master/source',true))() loadstring(game:HttpGet('https://raw.githubusercontent.com/Documantation12/Universal-Vehicle-Script/main/Main.lua'))() loadstring(game:HttpGet("https://pastebin.com/raw/DA8qiTD6"))() killAll() notify("All Executed + Kill All!") end, 3, 2)

    -- AIMBOT PAGE (fully restored & centered)
    local function createAimbotBtn(text, callback, x, y)
        local btn = Instance.new("TextButton", AimbotPage)
        btn.Size = UDim2.new(0, 300, 0, 70)
        btn.Position = UDim2.new(0, x, 0, y)
        btn.BackgroundColor3 = getgenv().HansGUIThemeColor:Lerp(Color3.fromRGB(40,40,40),0.4)
        btn.Text = text; btn.TextColor3 = Color3.new(1,1,1); btn.Font = Enum.Font.GothamBold; btn.TextSize = 22
        Instance.new("UICorner", btn).CornerRadius = UDim.new(0,14)
        addHover(btn, btn.Size, UDim2.new(0,310,0,78))
        table.insert(allButtons, btn)
        btn.MouseButton1Click:Connect(callback)
        return btn
    end
    AimbotToggleBtn = createAimbotBtn("Aimbot Toggle", function() getgenv().AimbotEnabled = not getgenv().AimbotEnabled notify("Aimbot " .. (getgenv().AimbotEnabled and "ON" or "OFF")) updateToggleButtons() end, 230, 20)
    ESPToggleBtn = createAimbotBtn("ESP Toggle", function() getgenv().ESPEnabled = not getgenv().ESPEnabled notify("ESP " .. (getgenv().ESPEnabled and "ON" or "OFF")) updateToggleButtons() end, 230, 110)

    -- FOV Slider (centered)
    local FOVLabel = Instance.new("TextLabel", AimbotPage)
    FOVLabel.Size = UDim2.new(0,400,0,40); FOVLabel.Position = UDim2.new(0.5,-200,0,200)
    FOVLabel.BackgroundTransparency = 1; FOVLabel.Text = "FOV Radius: "..math.round(getgenv().FOVRadius); FOVLabel.TextColor3 = Color3.new(1,1,1); FOVLabel.Font = Enum.Font.GothamBold; FOVLabel.TextSize = 22

    local SliderBack = Instance.new("Frame", AimbotPage)
    SliderBack.Size = UDim2.new(0,400,0,24); SliderBack.Position = UDim2.new(0.5,-200,0,240)
    SliderBack.BackgroundColor3 = Color3.fromRGB(50,50,50); Instance.new("UICorner",SliderBack).CornerRadius = UDim.new(0,12)
    local SliderFill = Instance.new("Frame", SliderBack)
    SliderFill.Size = UDim2.new(getgenv().FOVRadius/500,0,1,0); SliderFill.BackgroundColor3 = Color3.fromRGB(0,170,255); Instance.new("UICorner",SliderFill).CornerRadius = UDim.new(0,12)

    local dragging = false
    SliderBack.InputBegan:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then dragging = true end end)
    SliderBack.InputEnded:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end end)
    UserInputService.InputChanged:Connect(function(i) if dragging and i.UserInputType == Enum.UserInputType.MouseMovement then
        local p = math.clamp((i.Position.X - SliderBack.AbsolutePosition.X)/SliderBack.AbsoluteSize.X,0,1)
        getgenv().FOVRadius = p*500
        SliderFill.Size = UDim2.new(p,0,1,0)
        FOVLabel.Text = "FOV Radius: "..math.round(getgenv().FOVRadius)
    end end)

    -- FOV Colors (centered)
    local colors = {Color3.fromRGB(255,0,0),Color3.fromRGB(0,255,0),Color3.fromRGB(0,0,255),Color3.fromRGB(255,255,0),Color3.fromRGB(255,0,255),Color3.fromRGB(0,255,255),Color3.fromRGB(255,255,255)}
    for i,col in ipairs(colors) do
        local b = Instance.new("TextButton", AimbotPage)
        b.Size = UDim2.new(0,60,0,60); b.Position = UDim2.new(0, 110 + (i-1)*80, 0, 300)
        b.BackgroundColor3 = col; b.Text = ""; Instance.new("UICorner",b).CornerRadius = UDim.new(0,12)
        addHover(b,b.Size,UDim2.new(0,68,0,68))
        b.MouseButton1Click:Connect(function() getgenv().FOVColor = col notify("FOV Color Changed!") end)
    end

    -- THEME PAGE (fully restored)
    local presets = {Color3.fromRGB(30,30,40),Color3.fromRGB(255,0,100),Color3.fromRGB(0,170,255),Color3.fromRGB(170,0,255),Color3.fromRGB(255,170,0),Color3.fromRGB(0,255,150),Color3.fromRGB(255,70,70),Color3.fromRGB(100,255,100),Color3.fromRGB(255,215,0),Color3.fromRGB(0,255,255),Color3.fromRGB(255,105,180),Color3.fromRGB(138,43,226),Color3.fromRGB(0,191,255),Color3.fromRGB(255,20,147),Color3.fromRGB(50,205,50),Color3.fromRGB(255,165,0),Color3.fromRGB(70,130,180),Color3.fromRGB(220,20,60),Color3.fromRGB(124,252,0),Color3.fromRGB(255,255,255)}
    for i,col in ipairs(presets) do
        local x = 40 + ((i-1)%9)*82
        local y = 20 + math.floor((i-1)/9)*82
        local b = Instance.new("TextButton", ThemePage)
        b.Size = UDim2.new(0,72,0,72); b.Position = UDim2.new(0,x,0,y)
        b.BackgroundColor3 = col; b.Text = ""; Instance.new("UICorner",b).CornerRadius = UDim.new(0,16)
        addHover(b,b.Size,UDim2.new(0,80,0,80))
        b.MouseButton1Click:Connect(function() updateTheme(col) notify("Theme Changed!") end)
    end

    -- Random Theme Button (bottom center)
    local RandomBtn = Instance.new("TextButton", ThemePage)
    RandomBtn.Size = UDim2.new(0,300,0,70); RandomBtn.Position = UDim2.new(0.5,-150,0,320)
    RandomBtn.BackgroundColor3 = getgenv().HansGUIThemeColor:Lerp(Color3.fromRGB(40,40,40),0.4)
    RandomBtn.Text = "Random Theme"; RandomBtn.TextColor3 = Color3.new(1,1,1); RandomBtn.Font = Enum.Font.GothamBold; RandomBtn.TextSize = 24
    Instance.new("UICorner", RandomBtn).CornerRadius = UDim.new(0,16)
    addHover(RandomBtn, RandomBtn.Size, UDim2.new(0,310,0,78))
    RandomBtn.MouseButton1Click:Connect(function() updateTheme(Color3.fromRGB(math.random(0,255),math.random(0,255),math.random(0,255))) notify("Random Theme!") end)

    handleWalkSpeed()
    updateToggleButtons()
    switchTab(getgenv().HansGUIcurrentTab)
end

createGUI()

-- X Key Toggle
UserInputService.InputBegan:Connect(function(input, gp)
    if not gp and input.KeyCode == Enum.KeyCode.X then toggleGUI() end
end)

-- FOV Circle + ESP + Aimbot Loop
local FOVCircle = Drawing.new("Circle")
FOVCircle.Thickness = 2; FOVCircle.NumSides = 60; FOVCircle.Filled = false
local ESPBoxes = {}
local function clearESP() for _,b in pairs(ESPBoxes) do b.Visible = false; b:Remove() end ESPBoxes = {} end
local function getClosestInFOV()
    local closest, best = nil, getgenv().FOVRadius
    local center = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
    for _, plr in Players:GetPlayers() do
        if plr ~= LocalPlayer and plr.Team ~= LocalPlayer.Team and plr.Character and plr.Character:FindFirstChild("Head") then
            local head = plr.Character.Head
            local pos, onScreen = Camera:WorldToViewportPoint(head.Position)
            if onScreen then
                local dist = (Vector2.new(pos.X,pos.Y) - center).Magnitude
                if dist < best then
                    local ray = Ray.new(Camera.CFrame.Position, head.Position - Camera.CFrame.Position)
                    local hit = workspace:FindPartOnRayWithIgnoreList(ray, {LocalPlayer.Character})
                    if not hit or hit:IsDescendantOf(plr.Character) then
                        best = dist; closest = plr
                    end
                end
            end
        end
    end
    return closest
end

RunService.RenderStepped:Connect(function()
    FOVCircle.Position = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
    FOVCircle.Radius = getgenv().FOVRadius
    FOVCircle.Color = getgenv().FOVColor
    FOVCircle.Visible = getgenv().AimbotEnabled

    if getgenv().AimbotEnabled then
        local target = getClosestInFOV()
        if target and target.Character and target.Character:FindFirstChild("Head") then
            Camera.CFrame = CFrame.new(Camera.CFrame.Position, target.Character.Head.Position)
        end
    end

    clearESP()
    if getgenv().ESPEnabled then
        for _, plr in Players:GetPlayers() do
            if plr ~= LocalPlayer and plr.Team ~= LocalPlayer.Team and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
                local root = plr.Character.HumanoidRootPart
                local head = plr.Character:FindFirstChild("Head")
                if head then
                    local head3D = head.Position + Vector3.new(0,1.5,0)
                    local foot3D = root.Position - Vector3.new(0,3,0)
                    local headVp = Camera:WorldToViewportPoint(head3D)
                    local footVp = Camera:WorldToViewportPoint(foot3D)
                    if headVp.Z > 0 or footVp.Z > 0 then
                        local headPos = Vector2.new(headVp.X, headVp.Y)
                        local footPos = Vector2.new(footVp.X, footVp.Y)
                        local height = math.abs(headPos.Y - footPos.Y)
                        local width = height / 2
                        local box = Drawing.new("Square")
                        box.Size = Vector2.new(width, height)
                        box.Position = Vector2.new((headPos.X + footPos.X)/2 - width/2, math.min(headPos.Y, footPos.Y))
                        box.Color = Color3.fromRGB(0,255,0)
                        box.Thickness = 2; box.Filled = false; box.Visible = true
                        table.insert(ESPBoxes, box)
                    end
                end
            end
        end
    end
end)

notify("Han's GUI • Final Fixed Version • All Tabs Working • Enjoy!", 8)
